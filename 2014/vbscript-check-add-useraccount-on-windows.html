<!DOCTYPE html>
<html lang="en">
<head>
        <title>DevOTG : VBScript - Check & Add UserAccount on Windows</title>
        <meta charset="utf-8" />
        <meta name="description" content="DevOTG,Dev On The Go,IT,Book,Music,Movie,Etc">
        <meta name="viewport" content="width=device-width">
        <meta property="og:title" content="DevOTG">
        <meta property="og:description" content="DevOTG,Dev On The Go,IT,Book,Music,Movie,Etc">
        <meta name="google-site-verification" content="eP6pUaKlJOF7AJ_MUVZh7cTGxwy7XwhXRL0VZ3aeC5Q" />
        <meta name="naver-site-verification" content="4105a37922e68d2701c159b3cfe3913f162d8029"/>
        <link rel="stylesheet" href="http://chinium-dev.github.io/theme/css/main.css" type="text/css" />
        <link rel="stylesheet" href="http://chinium-dev.github.io/theme/css/colorbox.css" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
        <link href="http://chinium-dev.github.io/" type="application/atom+xml" rel="alternate" title="DevOTG ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://chinium-dev.github.io/css/ie.css"/>
                <script src="http://chinium-dev.github.io/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://chinium-dev.github.io/css/ie6.css"/><![endif]-->

</head>
<body>
	<div id="wrap">
	    <div id="container">

            <div class="entry">
<header>
<h1>
    <a href="http://chinium-dev.github.io" id="site-title">  </a>     <a href="http://chinium-dev.github.io/2014/vbscript-check-add-useraccount-on-windows.html" id="page-title">VBScript - Check & Add UserAccount on Windows</a>
</h1>
<!-- article-meta: START -->
<p class="article-meta">
<time datetime="2014-09-30T10:00:00+09:00">Tue 30 September 2014</time>    <span class="meta-category">
        Category: <a href="http://chinium-dev.github.io/category/it.html">IT</a>
    </span>
<span class="meta-tags">Tag: <a href="http://chinium-dev.github.io/tag/vbscript.html">VBScript</a></span></p>
<!-- article-meta: END --></header>
<article>
    <section id="article-main">

    </head><body><h3 id="using-wmi-service">Using WMI Service</h3>
<ul>
<li>GetObject("winmgmts:\ ...</li>
<li>Win32_UserAccount WMI Class<br/>
<a href="http://msdn.microsoft.com/en-us/library/aa394507(v=vs.85).aspx" target="_blank">http://msdn.microsoft.com/en-us/library/aa394507(v=vs.85).aspx</a></li>
</ul>
<h3 id="using-adsi-active-directory-service-interfaces">Using ADSI (Active Directory Service Interfaces)</h3>
<ul>
<li><a href="http://msdn.microsoft.com/en-us/library/aa746512(v=vs.85).aspx" target="_blank">http://msdn.microsoft.com/en-us/library/aa746512(v=vs.85).aspx</a></li>
</ul>
<h3 id="example">Example</h3>
<div class="hilitewrapper"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136</pre></div></td><td class="code"><div class="hilitewrapper"><div class="highlight"><pre><span></span><span class="c">' specify your new user account info</span>
<span class="k">Const</span> <span class="n">USERACCOUNT_ID</span> <span class="o">=</span> <span class="s">"newuser1"</span>
<span class="k">Const</span> <span class="n">USERACCOUNT_PW</span> <span class="o">=</span> <span class="s">"newpasswd!"</span>

<span class="k">Const</span> <span class="n">ADS_UF_DONT_EXPIRE_PASSWD</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">H10000</span>

<span class="k">Dim</span> <span class="n">gStrMsg</span>
<span class="k">Dim</span> <span class="n">gStrComputerName</span>


<span class="k">Call</span> <span class="n">Main</span><span class="p">()</span>


<span class="k">Function</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="k">On</span> <span class="k">Error</span> <span class="k">Resume</span> <span class="k">Next</span>

    <span class="k">Set</span> <span class="n">wshNetwork</span> <span class="o">=</span> <span class="n">WScript</span><span class="p">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">"WScript.Network"</span><span class="p">)</span>
    <span class="n">gStrComputerName</span> <span class="o">=</span> <span class="n">wshNetwork</span><span class="p">.</span><span class="n">ComputerName</span>
    <span class="n">WriteMsg</span> <span class="s">"Computer Name: "</span> <span class="o">&amp;</span> <span class="n">gStrComputerName</span>

    <span class="n">nRet</span> <span class="o">=</span> <span class="n">Check_UserAccount</span><span class="p">()</span>
    <span class="k">If</span> <span class="n">nRet</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="n">WriteMsg</span> <span class="s">"Check_UserAccount : nRet "</span> <span class="o">&amp;</span> <span class="n">nRet</span>
        <span class="n">wscript</span><span class="p">.</span><span class="n">quit</span>
    <span class="k">End</span> <span class="k">If</span>

    <span class="n">nRet</span> <span class="o">=</span> <span class="n">Add_UserAccount</span><span class="p">()</span>
    <span class="k">If</span> <span class="n">nRet</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="n">WriteMsg</span> <span class="s">"Add_UserAccount : nRet "</span> <span class="o">&amp;</span> <span class="n">nRet</span>
        <span class="n">wscript</span><span class="p">.</span><span class="n">quit</span>
    <span class="k">End</span> <span class="k">If</span>
<span class="k">End</span> <span class="k">Function</span>

<span class="c">'</span>
<span class="c">' Check if user account already exists or not</span>
<span class="c">'</span>
<span class="k">Function</span> <span class="nf">Check_UserAccount</span><span class="p">()</span>
    <span class="n">WriteMsg</span> <span class="s">"Check_UserAccount : Start"</span>
    <span class="n">nRet</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">On</span> <span class="k">Error</span> <span class="k">Resume</span> <span class="k">Next</span>

    <span class="k">Set</span> <span class="n">objWMIService</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"winmgmts:\\"</span> <span class="o">&amp;</span> <span class="n">gStrComputerName</span> <span class="o">&amp;</span> <span class="s">"\root\cimv2"</span><span class="p">)</span>
    <span class="k">Set</span> <span class="n">colAccounts</span> <span class="o">=</span> <span class="n">objWMIService</span><span class="p">.</span><span class="n">ExecQuery</span><span class="p">(</span><span class="s">"SELECT * FROM Win32_UserAccount WHERE LocalAccount = 'True' AND Name = '"</span> <span class="o">&amp;</span> <span class="n">USERACCOUNT_ID</span> <span class="o">&amp;</span> <span class="s">"'"</span><span class="p">)</span>
    <span class="k">If</span> <span class="n">Err</span><span class="p">.</span><span class="n">Number</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="k">If</span> <span class="n">colAccounts</span><span class="p">.</span><span class="n">Count</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">Then</span>
            <span class="n">WriteMsg</span> <span class="s">"UserAccount ("</span><span class="o">&amp;</span> <span class="n">USERACCOUNT_ID</span> <span class="o">&amp;</span><span class="s">") does not exists"</span>
        <span class="k">Else</span>
            <span class="n">nRet</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">WriteMsg</span> <span class="s">"UserAccount ("</span><span class="o">&amp;</span> <span class="n">USERACCOUNT_ID</span> <span class="o">&amp;</span><span class="s">") already exists"</span>
        <span class="k">End</span> <span class="k">If</span>
    <span class="k">Else</span>
        <span class="n">WriteErr</span> <span class="s">"Error when executing wmi query"</span>
        <span class="n">nRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="k">End</span> <span class="k">If</span>

    <span class="n">Check_UserAccount</span> <span class="o">=</span> <span class="n">nRet</span>
    <span class="n">WriteMsg</span> <span class="s">"Check_UserAccount : End"</span>
<span class="k">End</span> <span class="k">Function</span>


<span class="c">'</span>
<span class="c">' Add New UserAccount to Administrators Group</span>
<span class="c">'</span>
<span class="k">Function</span> <span class="nf">Add_UserAccount</span><span class="p">()</span>
    <span class="n">WriteMsg</span> <span class="s">"Add_UserAccount : Start"</span>
    <span class="n">nRet</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">On</span> <span class="k">Error</span> <span class="k">Resume</span> <span class="k">Next</span>

    <span class="k">set</span> <span class="n">objSystem</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"WinNT://"</span> <span class="o">&amp;</span> <span class="n">gStrComputerName</span> <span class="o">&amp;</span> <span class="s">""</span><span class="p">)</span>
    <span class="k">If</span> <span class="n">Err</span><span class="p">.</span><span class="n">Number</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="n">WriteErr</span> <span class="s">"Error when getting domain object : step 1"</span>
        <span class="n">nRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">200</span>
        <span class="n">Add_UserAccount</span> <span class="o">=</span> <span class="n">nRet</span>
        <span class="k">Exit</span> <span class="k">Function</span>
    <span class="nf">End</span> <span class="k">If</span>

    <span class="k">set</span> <span class="n">objUser</span> <span class="o">=</span> <span class="n">objSystem</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="s">"user"</span><span class="p">,</span> <span class="n">USERACCOUNT_ID</span><span class="p">)</span>
    <span class="k">If</span> <span class="n">Err</span><span class="p">.</span><span class="n">Number</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="n">WriteErr</span> <span class="s">"Error when creating useraccount : step 2"</span>
        <span class="n">nRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">200</span>
        <span class="n">Add_UserAccount</span> <span class="o">=</span> <span class="n">nRet</span>
        <span class="k">Exit</span> <span class="k">Function</span>
    <span class="nf">End</span> <span class="k">If</span>

    <span class="n">objUser</span><span class="p">.</span><span class="n">SetPassword</span> <span class="n">chr</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USERACCOUNT_PW</span> <span class="o">&amp;</span> <span class="n">chr</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span>
    <span class="n">objUser</span><span class="p">.</span><span class="n">SetInfo</span>
    <span class="k">If</span> <span class="n">Err</span><span class="p">.</span><span class="n">Number</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="n">WriteErr</span> <span class="s">"Error when setting password : step 3"</span>
        <span class="n">nRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">210</span>
        <span class="n">Add_UserAccount</span> <span class="o">=</span> <span class="n">nRet</span>
        <span class="k">Exit</span> <span class="k">Function</span>
    <span class="nf">End</span> <span class="k">If</span>

    <span class="n">objUser</span><span class="p">.</span><span class="n">AccountDisabled</span> <span class="o">=</span> <span class="k">FALSE</span>
    <span class="n">objUser</span><span class="p">.</span><span class="n">Put</span> <span class="s">"PasswordExpired"</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">oldFlags</span> <span class="o">=</span> <span class="n">objUser</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"UserFlags"</span><span class="p">)</span>
    <span class="n">newFlags</span> <span class="o">=</span> <span class="n">oldFlags</span> <span class="ow">Or</span> <span class="n">ADS_UF_DONT_EXPIRE_PASSWD</span>
    <span class="n">objUser</span><span class="p">.</span><span class="n">Put</span> <span class="s">"UserFlags"</span><span class="p">,</span> <span class="n">newFlags</span>
    <span class="n">objUser</span><span class="p">.</span><span class="n">SetInfo</span>
    <span class="k">If</span> <span class="n">Err</span><span class="p">.</span><span class="n">Number</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="n">WriteErr</span> <span class="s">"Error when setting password expiration : step 4"</span>
        <span class="n">nRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">220</span>
        <span class="n">Add_UserAccount</span> <span class="o">=</span> <span class="n">nRet</span>
        <span class="k">Exit</span> <span class="k">Function</span>
    <span class="nf">End</span> <span class="k">If</span>

    <span class="c">' add user account to administrators group</span>
    <span class="k">Set</span> <span class="n">objGroup</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">"WinNT://"</span> <span class="o">&amp;</span> <span class="n">gStrComputerName</span> <span class="o">&amp;</span> <span class="s">"/administrators,group"</span><span class="p">)</span>
    <span class="n">WriteMsg</span> <span class="s">"- ADsPath : "</span> <span class="o">&amp;</span> <span class="n">objUser</span><span class="p">.</span><span class="n">ADsPath</span>
    <span class="n">objGroup</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">objUser</span><span class="p">.</span><span class="n">ADsPath</span><span class="p">)</span>
    <span class="k">If</span> <span class="n">Err</span><span class="p">.</span><span class="n">Number</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="n">WriteErr</span> <span class="s">"Error when adding user account to administrators group : step 5"</span>
        <span class="n">nRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">230</span>
        <span class="n">Add_UserAccount</span> <span class="o">=</span> <span class="n">nRet</span>
        <span class="k">Exit</span> <span class="k">Function</span>
    <span class="nf">End</span> <span class="k">If</span>

    <span class="n">WriteMsg</span> <span class="s">"UserAccount ("</span> <span class="o">&amp;</span> <span class="n">USERACCOUNT_ID</span> <span class="o">&amp;</span> <span class="s">") has been added"</span>

    <span class="n">gStrMsg</span> <span class="o">=</span> <span class="n">gStrMsg</span> <span class="o">&amp;</span> <span class="n">vbcrlf</span> <span class="o">&amp;</span> <span class="s">"Adding UserAccount OK"</span>
    <span class="n">Add_UserAccount</span> <span class="o">=</span> <span class="n">nRet</span>

    <span class="n">WriteMsg</span> <span class="s">"Add_UserAccount : End"</span>
<span class="k">End</span> <span class="k">Function</span>


<span class="k">Sub</span> <span class="nf">WriteMsg</span><span class="p">(</span><span class="n">strMessage</span><span class="p">)</span>
    <span class="n">wscript</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">writeline</span> <span class="n">strMessage</span>
<span class="k">End</span> <span class="k">Sub</span>


<span class="k">Sub</span> <span class="nf">WriteErr</span><span class="p">(</span><span class="n">strMessage</span><span class="p">)</span>
    <span class="n">wscript</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">writeline</span> <span class="n">strMessage</span>
    <span class="n">wscript</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">writeline</span> <span class="n">Err</span><span class="p">.</span><span class="n">Number</span> <span class="o">&amp;</span> <span class="s">" Src: "</span> <span class="o">&amp;</span> <span class="n">Err</span><span class="p">.</span><span class="n">Source</span> <span class="o">&amp;</span> <span class="s">" Desc: "</span> <span class="o">&amp;</span>  <span class="n">Err</span><span class="p">.</span><span class="n">Description</span>
    <span class="n">Err</span><span class="p">.</span><span class="n">Clear</span>
<span class="k">End</span> <span class="k">Sub</span>
</pre></div></div>
</td></tr></tbody></table></div>
    </section>

    <section id="article-comment">
    </section>

            <section id="article-list">
                <h2>Latest posts</h2>
                <ol>
                    <li>
                        <a href="http://chinium-dev.github.io/2018/ovsdb-server-how-to-enable-tlsv1_2-only.html" rel="bookmark" title="Permalink to ovsdb-server - How to enable tlsv1_2 only">ovsdb-server - How to enable tlsv1_2 only</a>
<!-- article-meta: START -->
<p class="article-meta">
<time datetime="2018-07-09T12:00:00+09:00">Mon 09 July 2018</time>    <span class="meta-category">
        Category: <a href="http://chinium-dev.github.io/category/it.html">IT</a>
    </span>
<span class="meta-tags">Tag: <a href="http://chinium-dev.github.io/tag/ovirt.html">oVirt</a>, <a href="http://chinium-dev.github.io/tag/ovsdb-server.html">ovsdb-server</a>, <a href="http://chinium-dev.github.io/tag/tls.html">tls</a></span></p>
<!-- article-meta: END -->                    </li>
                    <li>
                        <a href="http://chinium-dev.github.io/2018/ISBN-9788925593289.html" rel="bookmark" title="Permalink to Book - 브루투스의 심장">Book - 브루투스의 심장</a>
<!-- article-meta: START -->
<p class="article-meta">
<time datetime="2018-07-08T10:00:00+09:00">Sun 08 July 2018</time>    <span class="meta-category">
        Category: <a href="http://chinium-dev.github.io/category/book.html">Book</a>
    </span>
<span class="meta-tags">Tag: <a href="http://chinium-dev.github.io/tag/higasino-geigo.html">히가시노 게이고</a>, <a href="http://chinium-dev.github.io/tag/1989.html">1989</a></span></p>
<!-- article-meta: END -->                    </li>
                    <li>
                        <a href="http://chinium-dev.github.io/2018/ISBN-9791159037795.html" rel="bookmark" title="Permalink to Book - 인간 실격">Book - 인간 실격</a>
<!-- article-meta: START -->
<p class="article-meta">
<time datetime="2018-06-21T10:00:00+09:00">Thu 21 June 2018</time>    <span class="meta-category">
        Category: <a href="http://chinium-dev.github.io/category/book.html">Book</a>
    </span>
<span class="meta-tags">Tag: <a href="http://chinium-dev.github.io/tag/dajai-osamu.html">다자이 오사무</a></span></p>
<!-- article-meta: END -->                    </li>
                    <li>
                        <a href="http://chinium-dev.github.io/2018/zlib-compression-library.html" rel="bookmark" title="Permalink to zlib Compression Library">zlib Compression Library</a>
<!-- article-meta: START -->
<p class="article-meta">
<time datetime="2018-04-19T10:00:00+09:00">Thu 19 April 2018</time>    <span class="meta-category">
        Category: <a href="http://chinium-dev.github.io/category/it.html">IT</a>
    </span>
<span class="meta-tags">Tag: <a href="http://chinium-dev.github.io/tag/compression.html">Compression</a>, <a href="http://chinium-dev.github.io/tag/zlib.html">zlib</a></span></p>
<!-- article-meta: END -->                    </li>
                    <li>
                        <a href="http://chinium-dev.github.io/2018/algorithm-crc.html" rel="bookmark" title="Permalink to CRC (Cyclic Redundancy Check) - 순환 중복 검사">CRC (Cyclic Redundancy Check) - 순환 중복 검사</a>
<!-- article-meta: START -->
<p class="article-meta">
<time datetime="2018-04-14T16:00:00+09:00">Sat 14 April 2018</time>    <span class="meta-category">
        Category: <a href="http://chinium-dev.github.io/category/it.html">IT</a>
    </span>
<span class="meta-tags">Tag: <a href="http://chinium-dev.github.io/tag/algorithm.html">Algorithm</a>, <a href="http://chinium-dev.github.io/tag/crc.html">CRC</a></span></p>
<!-- article-meta: END -->                    </li>
                </ol>
            </section>
</article>
            </div>
        </div>

        <div id="sidebar" class="position-sticky-top">
            <h1><a href="http://chinium-dev.github.io " title="title">DevOTG</a></h1>
            <span class="description">Dev On The Go </span>
            <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->

            <nav>
              <h5>Pages</h5>
              <ul>
				  <li><a href="http://chinium-dev.github.io/pages/about.html">About</a></li>
				  <li><a href="http://chinium-dev.github.io/pages/music.html">Music</a></li>
              </ul>
            </nav>

            <nav>
              <h5>Categories</h5>
              <ul>
                <li ><a href="http://chinium-dev.github.io/category/book.html">Book (10)</a></li>
                <li class="active"><a href="http://chinium-dev.github.io/category/it.html">IT (27)</a></li>
                <li ><a href="http://chinium-dev.github.io/category/movie.html">Movie (2)</a></li>
                <li ><a href="http://chinium-dev.github.io/category/music.html">Music (184)</a></li>
              </ul>
            </nav>




            <nav>
              <aside>
                  <h5><a href="http://chinium-dev.github.io/tags.html">Tags</a></h5>
              </aside>
            </nav>
            <nav>
              <aside>
                  <h5><a href="http://chinium-dev.github.io/archives.html">Archives</a></h5>
              </aside>
            </nav>
        </div>

        <div id="footer">
            <div id="credits">
                <span>© 2018 DevOTG - Powered by <a href="https://getpelican.com" target="_blank">Pelican</a> and <a href="https://github.com/getpelican/pelican-themes/tree/master/monospace" target="_blank">Monospace</a></span>
            </div>
        </div>


    </div>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "pub-2423046871112218",
            enable_page_level_ads: true
        });
    </script>
    <script src="http://chinium-dev.github.io/theme/js/jquery.min.js"></script>
    <script src="http://chinium-dev.github.io/theme/js/jquery.colorbox-min.js"></script>
    <script src="http://chinium-dev.github.io/theme/js/load-colorbox.js"></script>
</body>
</html>